<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAPRI App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="{% static 'css/papriapp.css' %}">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    <style>
        [x-cloak] { display: none !important; }
        .sidebar-icon { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; flex-shrink: 0; }
        .active-nav-link { background-color: #374151; /* Tailwind gray-700 */ color: white; border-left: 3px solid #6366F1; /* Tailwind indigo-500 */}
        .modal-overlay { background-color: rgba(17, 24, 39, 0.85); /* Tailwind gray-900 with more opacity */ }
        .input-spinner { border: 2px solid #4A5568; border-top-color: #6366F1; border-radius: 50%; width: 1rem; height: 1rem; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .custom-file-input-label
            cursor: pointer;
            display: inline-block;
            padding: 0.5rem 1rem; /* Example padding */
            background-color: #4F46E5; /* Example: indigo-600 */
            color: white;
            border-radius: 0.375rem; /* Example: rounded-md */
            font-weight: 600; /* Example: semibold */
            transition: background-color 0.2s;
        }
        .custom-file-input-label:hover {
            background-color: #4338CA; /* Example: indigo-700 */
        }
        .custom-file-input-label:focus { /* Explicit focus style for the label */
            outline: 2px solid #6366F1;
            outline-offset: 2px;
        }
        .visually-hidden { /* For hiding the actual <input type="file"> */
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased" 
      x-data="papriApp()" 
      @hashchange.window="handleHashChange()" 
      x-init="initializeApplication()">

    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-gray-800 shadow-md flex-shrink-0 hidden md:flex md:flex-col overflow-y-auto">
            <div class="p-5 border-b border-gray-700">
                <a href="#search" @click="currentView = 'search'" class="text-2xl font-bold text-white hover:text-indigo-400" aria-label="PAPRI AI Home">PAPRI AI</a>
            </div>
            <nav class="mt-4 flex-grow" aria-label="Main application navigation">
                <a href="#search" @click="currentView = 'search'" 
                   class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200"
                   :class="{ 'active-nav-link': currentView === 'search' }" role="button" :aria-current="currentView === 'search' ? 'page' : undefined">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    Search
                </a>
                <a href="#editor" @click="currentView = 'editor'"
                   class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200"
                   :class="{ 'active-nav-link': currentView === 'editor' }" role="button" :aria-current="currentView === 'editor' ? 'page' : undefined">
                     <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    AI Video Editor
                </a>
                <a href="#history" @click="currentView = 'history'"
                   class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200"
                   :class="{ 'active-nav-link': currentView === 'history' }" role="button" :aria-current="currentView === 'history' ? 'page' : undefined">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    History
                </a>
                <a href="#collections" @click="currentView = 'collections'"
                   class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200"
                   :class="{ 'active-nav-link': currentView === 'collections' }" role="button" :aria-current="currentView === 'collections' ? 'page' : undefined">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 11h10"></path></svg>
                    Collections
                </a>
                <a href="#settings" @click="currentView = 'settings'"
                   class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200"
                   :class="{ 'active-nav-link': currentView === 'settings' }" role="button" :aria-current="currentView === 'settings' ? 'page' : undefined">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </a>
            </nav>
            <div class="mt-auto p-5 border-t border-gray-700">
                 <div x-show="authenticatedUser" x-cloak class="mb-3">
                    <p class="text-xs text-gray-400" id="user-logged-in-label-desktop">Logged in as:</p>
                    <p class="font-semibold text-sm text-white truncate" x-text="authenticatedUser.email" :title="authenticatedUser.email" aria-labelledby="user-logged-in-label-desktop"></p>
                 </div>
                <button @click="logoutUser()"
                   class="flex items-center justify-center w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg transition duration-150 text-sm">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Logout
                </button>
            </div>
        </aside>

        <div x-show="isSidebarOpen" x-cloak 
            class="fixed inset-0 z-40 flex md:hidden"
            x-transition:enter="transition ease-in-out duration-300 transform"
            x-transition:enter-start="-translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-in-out duration-300 transform"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="-translate-x-full"
            role="dialog" aria-modal="true" aria-labelledby="mobile-sidebar-heading">
            
            <div @click="isSidebarOpen = false" class="fixed inset-0 bg-black opacity-50" aria-hidden="true"></div>
            <aside class="relative w-64 bg-gray-800 shadow-md flex-shrink-0 flex flex-col overflow-y-auto">
                <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                     <h2 id="mobile-sidebar-heading" class="text-2xl font-bold text-white hover:text-indigo-400">PAPRI AI</h2>
                     <button @click="isSidebarOpen = false" class="text-gray-400 hover:text-white" aria-label="Close menu">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                     </button>
                </div>
                <nav class="mt-4 flex-grow" aria-label="Mobile application navigation">
                    <a href="#search" @click="currentView = 'search'; isSidebarOpen = false" class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white" :class="{ 'active-nav-link': currentView === 'search' }" role="button">Search</a>
                    <a href="#editor" @click="currentView = 'editor'; isSidebarOpen = false" class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white" :class="{ 'active-nav-link': currentView === 'editor' }" role="button">AI Video Editor</a>
                    <a href="#history" @click="currentView = 'history'; isSidebarOpen = false" class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white" :class="{ 'active-nav-link': currentView === 'history' }" role="button">History</a>
                    <a href="#collections" @click="currentView = 'collections'; isSidebarOpen = false" class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white" :class="{ 'active-nav-link': currentView === 'collections' }" role="button">Collections</a>
                    <a href="#settings" @click="currentView = 'settings'; isSidebarOpen = false" class="flex items-center px-5 py-3 text-gray-300 hover:bg-gray-700 hover:text-white" :class="{ 'active-nav-link': currentView === 'settings' }" role="button">Settings</a>
                </nav>
                 <div class="mt-auto p-5 border-t border-gray-700">
                    <div x-show="authenticatedUser" x-cloak class="mb-3">
                        <p class="text-xs text-gray-400" id="user-logged-in-label-mobile">Logged in as:</p>
                        <p class="font-semibold text-sm text-white truncate" x-text="authenticatedUser.email" :title="authenticatedUser.email" aria-labelledby="user-logged-in-label-mobile"></p>
                     </div>
                    <button @click="logoutUser(); isSidebarOpen = false" class="flex items-center justify-center w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">Logout</button>
                </div>
            </aside>
        </div>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-4 sm:p-6 md:p-8">
            <div class="md:hidden flex items-center justify-between mb-6">
                 <a href="#search" @click="currentView = 'search'" class="text-xl font-bold text-white hover:text-indigo-400">PAPRI AI</a>
                <button @click="isSidebarOpen = !isSidebarOpen" class="text-gray-300 hover:text-white focus:outline-none" aria-controls="mobile-sidebar-heading" :aria-expanded="isSidebarOpen.toString()">
                    <span class="sr-only">Open menu</span>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>
            
            <div x-show="isLoading" x-cloak class="flex justify-center items-center h-64">
                 <div class="input-spinner w-12 h-12 border-4" role="status" aria-label="Loading application data"></div>
            </div>

            <div x-show="!isLoading">
                <div x-show="currentView === 'search'" x-cloak id="search-view" class="space-y-6" aria-labelledby="search-view-heading">
                    <h1 id="search-view-heading" class="text-3xl font-bold text-white">Video Search</h1>
                    <form @submit.prevent="initiateNewSearchTask" class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-4" aria-describedby="search-status-message-live-region">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="main-query-text" class="block text-sm font-medium text-gray-300 mb-1">Text Query:</label>
                                <input type="text" id="main-query-text" x-model="searchForm.query_text" :disabled="searchLoading"
                                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400"
                                       placeholder="e.g., 'latest AI advancements', 'cat jumping fail'">
                            </div>
                            <div>
                                <label for="main-query-image-input" class="block text-sm font-medium text-gray-300 mb-1">Image Query (Optional):</label>
                                <label for="main-query-image-input" class="custom-file-input-label" role="button" tabindex="0" @keydown.enter="$el.click()" @keydown.space="$el.click()">Choose File</label>
                                <input type="file" id="main-query-image-input" @change="handleSearchImageFile($event)" :disabled="searchLoading" accept="image/*" class="visually-hidden">
                                <p x-show="searchForm.query_image_name" x-cloak class="text-xs text-gray-400 mt-1" x-text="`Selected: ${searchForm.query_image_name}`" aria-live="polite"></p>
                            </div>
                        </div>
                        <div>
                            <label for="main-query-url" class="block text-sm font-medium text-gray-300 mb-1">Specific Video URL (Optional):</label>
                            <input type="url" id="main-query-url" x-model="searchForm.query_video_url" :disabled="searchLoading"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400"
                                   placeholder="e.g., https://www.youtube.com/watch?v=...">
                        </div>

                        <div class="p-3 border border-gray-700 rounded-md" x-data="{ showFilters: false }">
                            <button type="button" @click="showFilters = !showFilters" class="text-indigo-400 hover:text-indigo-300 font-semibold mb-2 flex items-center text-sm" :aria-expanded="showFilters.toString()" aria-controls="advanced-filters-content">
                                Advanced Filters
                                <svg :class="{'transform rotate-180': showFilters}" class="w-4 h-4 ml-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div x-show="showFilters" x-collapse x-cloak id="advanced-filters-content" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 pt-2">
                                <div>
                                    <label for="filter-platform" class="block text-xs font-medium text-gray-400">Platform(s):</label>
                                    <select id="filter-platform" x-model="searchForm.filters.platform" multiple :disabled="searchLoading"
                                            class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:ring-indigo-500 focus:border-indigo-500 h-20">
                                        <option value="youtube">YouTube</option> <option value="vimeo">Vimeo</option>
                                        <option value="dailymotion">Dailymotion</option> <option value="peertube">PeerTube</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-min-duration" class="block text-xs font-medium text-gray-400">Min Duration (sec):</label>
                                    <input type="number" id="filter-min-duration" x-model.number="searchForm.filters.min_duration_sec" :disabled="searchLoading" class="w-full mt-1 px-2 py-1 bg-gray-700 border-gray-600 rounded-md text-sm" placeholder="e.g. 60">
                                </div>
                                <div>
                                    <label for="filter-max-duration" class="block text-xs font-medium text-gray-400">Max Duration (sec):</label>
                                    <input type="number" id="filter-max-duration" x-model.number="searchForm.filters.max_duration_sec" :disabled="searchLoading" class="w-full mt-1 px-2 py-1 bg-gray-700 border-gray-600 rounded-md text-sm" placeholder="e.g. 600">
                                </div>
                                <div>
                                    <label for="filter-date-after" class="block text-xs font-medium text-gray-400">Uploaded After:</label>
                                    <input type="date" id="filter-date-after" x-model="searchForm.filters.upload_date_after" :disabled="searchLoading" class="w-full mt-1 px-2 py-1 bg-gray-700 border-gray-600 rounded-md text-sm text-gray-400">
                                </div>
                                 <div class="col-span-full sm:col-span-2 lg:col-span-4 flex justify-end gap-2 mt-2">
                                     <button type="button" @click="resetFilters()" :disabled="searchLoading" class="px-3 py-1 text-xs bg-gray-600 hover:bg-gray-500 rounded-md">Reset Filters</button>
                                     <button type="button" @click="applyFiltersAndReSearch()" :disabled="searchLoading" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded-md">Apply Filters</button>
                                 </div>
                            </div>
                        </div>

                        <div class="text-center pt-2">
                            <button type="submit" :disabled="searchLoading"
                                    class="bg-indigo-600 hover:bg-indigo-700 disabled:opacity-60 text-white font-bold py-2.5 px-6 rounded-md text-lg transition duration-150 flex items-center justify-center mx-auto min-w-[120px]">
                                <svg x-show="searchLoading" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" role="status" aria-label="Searching"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span x-text="searchLoading ? 'Searching...' : 'Search'"></span>
                            </button>
                        </div>
                    </form>

                    <div id="search-status-message-live-region" x-show="searchStatusMessage" x-cloak :class="{ 'bg-blue-800 text-blue-200': !searchErrorMessage, 'bg-red-800 text-red-200': searchErrorMessage }" 
                         class="p-3 rounded-md text-sm" role="status" aria-live="polite" x-text="searchStatusMessage">
                    </div>

                    <div id="search-results-area" class="space-y-6" aria-live="polite" aria-atomic="true">
                        <template x-if="searchResults.length > 0">
                            <div>
                                <h2 class="text-2xl font-semibold text-white mb-4">Results (<span x-text="searchTotalResults"></span>)</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                    <template x-for="(result, index) in searchResults" :key="result.id">
                                        <article class="bg-gray-800 rounded-lg shadow-lg overflow-hidden hover:shadow-indigo-500/40 transition-shadow flex flex-col" :aria-labelledby="`result-title-${index}`">
                                            <button @click="playVideoModal(result)" class="block w-full h-40 bg-black focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500" :aria-label="`Play video: ${result.title}`">
                                                <img :src="result.primary_source_display?.thumbnail_url || result.sources?.[0]?.thumbnail_url || '{% static 'images/placeholder_thumb.png' %}'" 
                                                     :alt="`Thumbnail for ${result.title}`" class="w-full h-full object-cover">
                                            </button>
                                            <div class="p-4 flex flex-col flex-grow">
                                                <h3 :id="`result-title-${index}`" class="font-semibold text-md mb-1 text-white hover:text-indigo-300 cursor-pointer" 
                                                    x-text="result.title" @click="playVideoModal(result)"></h3>
                                                <p class="text-xs text-gray-400 mb-2">
                                                    <span x-text="result.primary_source_display?.platform_name || result.sources?.[0]?.platform_name"></span>
                                                    - <span x-text="result.primary_source_display?.uploader_name || result.sources?.[0]?.uploader_name || 'N/A'"></span>
                                                </p>
                                                <p class="text-xs text-gray-500 mb-1" x-text="`Duration: ${formatDuration(result.duration_seconds)} | Score: ${result.relevance_score?.toFixed(2)}`"></p>
                                                <p x-show="result.primary_source_display?.relevant_text_snippet" class="text-xs text-gray-300 italic my-1 p-2 bg-gray-700 rounded max-h-16 overflow-y-auto" x-html="`Snippet: &quot;${result.primary_source_display.relevant_text_snippet}&quot;`"></p>
                                                <p x-show="result.primary_source_display?.best_match_timestamp_ms" class="text-xs text-gray-400">Best match at: <span class="font-semibold text-indigo-300" x-text="formatTimestamp(result.primary_source_display.best_match_timestamp_ms)"></span></p>
                                                
                                                <div class="mt-auto pt-3 flex flex-wrap gap-2 justify-start items-center text-xs">
                                                    <a :href="result.primary_source_display?.original_url || result.sources?.[0]?.original_url" target="_blank" rel="noopener noreferrer"
                                                       class="text-indigo-400 hover:text-indigo-300 font-medium py-1 px-2 rounded hover:bg-gray-700 focus:outline-none focus-visible:ring-1 focus-visible:ring-indigo-400">View Source</a>
                                                    <button @click="openAiEditor(result)" class="bg-purple-600 hover:bg-purple-700 text-white py-1 px-2 rounded font-medium focus:outline-none focus-visible:ring-1 focus-visible:ring-purple-400">Edit with AI</button>
                                                    <button @click="addToCollection(result)" class="text-gray-400 hover:text-white py-1 px-2 rounded hover:bg-gray-700 focus:outline-none focus-visible:ring-1 focus-visible:ring-gray-500" aria-label="Save to collection">Save</button>
                                                </div>
                                            </div>
                                        </article>
                                    </template>
                                </div>
                                <nav x-show="searchTotalPages > 1" class="mt-8 flex justify-center items-center space-x-2" aria-label="Search results pagination">
                                    <button @click="fetchResultsPage(searchCurrentPage - 1)" :disabled="searchLoading || searchCurrentPage <= 1"
                                            class="px-3 py-1 bg-gray-700 hover:bg-indigo-600 rounded disabled:opacity-50 focus:outline-none focus-visible:ring-1 focus-visible:ring-indigo-400" aria-label="Previous page">Prev</button>
                                    <span class="text-gray-300 text-sm" x-text="`Page ${searchCurrentPage} of ${searchTotalPages}`" :aria-label="`Current page ${searchCurrentPage} of ${searchTotalPages}`"></span>
                                    <button @click="fetchResultsPage(searchCurrentPage + 1)" :disabled="searchLoading || searchCurrentPage >= searchTotalPages"
                                            class="px-3 py-1 bg-gray-700 hover:bg-indigo-600 rounded disabled:opacity-50 focus:outline-none focus-visible:ring-1 focus-visible:ring-indigo-400" aria-label="Next page">Next</button>
                                </nav>
                            </div>
                        </template>
                        <template x-if="!searchLoading && searchResults.length === 0 && searchAttempted">
                            <p class="text-center text-gray-400 py-8">No results found for your query. Try different keywords or adjust filters.</p>
                        </template>
                         <template x-if="searchLoading && searchResults.length === 0 && searchAttempted">
                            <p class="text-center text-gray-400 py-8 flex items-center justify-center"><span class="input-spinner mr-2" role="status" aria-label="Loading results"></span> Loading results...</p>
                        </template>
                    </div>
                </div>

                <div x-show="currentView === 'editor'" x-cloak id="editor-view" class="space-y-6" aria-labelledby="editor-view-heading">
                    <h1 id="editor-view-heading" class="text-3xl font-bold text-white">AI Video Editor</h1>
                    <form @submit.prevent="initiateVideoEdit" class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-4" aria-describedby="editor-status-message-live-region">
                        <div>
                            <label for="editor-video-upload-input" class="block text-sm font-medium text-gray-300 mb-1">Video to Edit:</label>
                            <div x-show="editorVideoSource" x-cloak class="p-3 bg-gray-700 rounded-md mb-2 flex justify-between items-center">
                                <div>
                                    <p class="text-white font-semibold" x-text="editorVideoSource.title"></p>
                                    <p class="text-xs text-gray-400" x-text="editorVideoSource.original_url || editorVideoSource.uploaded_name"></p>
                                </div>
                                <button type="button" @click="clearEditorVideoSource()" class="text-xs text-red-400 hover:text-red-300 ml-2 py-1 px-2 rounded hover:bg-red-900/50 focus:outline-none focus-visible:ring-1 focus-visible:ring-red-400" aria-label="Clear video source">Clear</button>
                            </div>
                             <label for="editor-video-upload-input" class="custom-file-input-label" role="button" tabindex="0" @keydown.enter="$el.click()" @keydown.space="$el.click()" x-show="!editorVideoSource">
                                Upload Video File
                            </label>
                            <input type="file" id="editor-video-upload-input" @change="handleEditorVideoUpload($event)" accept="video/*" :disabled="editorLoading" class="visually-hidden" x-show="!editorVideoSource">
                            <p class="text-xs text-gray-500 mt-1" x-show="!editorVideoSource">Select a video from search results (via "Edit with AI") or upload a new one here.</p>
                        </div>

                        <div>
                            <label for="editor-prompt" class="block text-sm font-medium text-gray-300 mb-1">Editing Instructions (Text Prompt):</label>
                            <textarea id="editor-prompt" x-model="editorPrompt" rows="3" :disabled="!editorVideoSource || editorLoading"
                                      class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400"
                                      placeholder="e.g., 'Cut the first 5 seconds and add text \"Hello Papri\" at 10s for 3s'"></textarea>
                        </div>

                        <div class="text-center pt-2">
                            <button type="submit" :disabled="!editorVideoSource || !editorPrompt.trim() || editorLoading"
                                    class="bg-purple-600 hover:bg-purple-700 disabled:opacity-60 text-white font-bold py-2.5 px-6 rounded-md text-lg transition duration-150 flex items-center justify-center mx-auto min-w-[150px]">
                                <svg x-show="editorLoading" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" role="status" aria-label="Processing video"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span x-text="editorLoading ? 'Processing...' : 'Process Video'"></span>
                            </button>
                        </div>
                    </form>

                    <div id="editor-status-message-live-region" x-show="editorStatusMessage" x-cloak :class="{ 'bg-blue-800 text-blue-200': !editorErrorMessage, 'bg-red-800 text-red-200': editorErrorMessage }" 
                         class="p-3 rounded-md text-sm" role="status" aria-live="polite" x-text="editorStatusMessage">
                    </div>

                    <div x-show="editedVideoUrl" x-cloak class="mt-6 bg-gray-800 p-4 rounded-lg" aria-labelledby="edited-video-heading">
                        <h3 id="edited-video-heading" class="text-xl font-semibold text-white mb-3">Edited Video Preview:</h3>
                        <div class="aspect-video bg-black rounded overflow-hidden shadow-md">
                            <video id="edited-video-player" controls playsinline data-plyr-config='{ "ratio": "16:9" }' aria-label="Edited video player"></video>
                        </div>
                        <a :href="editedVideoUrl" download="papri_edited_video.mp4"
                           class="mt-4 inline-block bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">
                           Download Edited Video
                        </a>
                    </div>
                </div>

                <div x-show="currentView === 'history'" x-cloak id="history-view" aria-labelledby="history-view-heading">
                    <h1 id="history-view-heading" class="text-3xl font-bold text-white">Search History</h1>
                    <p class="text-gray-400 mt-4">Your past searches will appear here. (Feature coming soon)</p>
                </div>

                <div x-show="currentView === 'collections'" x-cloak id="collections-view" aria-labelledby="collections-view-heading">
                    <h1 id="collections-view-heading" class="text-3xl font-bold text-white">My Collections</h1>
                    <p class="text-gray-400 mt-4">Organize your favorite videos into collections. (Feature coming soon)</p>
                </div>

                <div x-show="currentView === 'settings'" x-cloak id="settings-view" class="space-y-6" aria-labelledby="settings-view-heading">
                    <h1 id="settings-view-heading" class="text-3xl font-bold text-white">Settings</h1>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-6">
                        <section aria-labelledby="profile-settings-heading">
                            <h2 id="profile-settings-heading" class="text-xl font-semibold text-gray-200 mb-2">User Profile</h2>
                            <div x-show="authenticatedUser" class="text-gray-300 space-y-1 text-sm">
                                <p><strong>Email:</strong> <span x-text="authenticatedUser.email"></span></p>
                                <p><strong>Username:</strong> <span x-text="authenticatedUser.username || 'N/A'"></span></p>
                            </div>
                            <div x-show="!authenticatedUser" class="text-gray-400 text-sm">
                                <p>You are not currently logged in.</p>
                                <a href="{% get_account_url 'login' %}" class="text-indigo-400 hover:underline">Login</a> or 
                                <a href="{% get_account_url 'signup' %}" class="text-indigo-400 hover:underline">Sign Up</a>
                            </div>
                             <a x-show="authenticatedUser" href="get_account_url 'password_change'" class="mt-3 inline-block text-sm text-indigo-400 hover:text-indigo-300 hover:underline">Change Password</a>
                        </section>
                        <hr class="border-gray-700">
                        <section aria-labelledby="subscription-settings-heading">
                            <h2 id="subscription-settings-heading" class="text-xl font-semibold text-gray-200 mb-2">Subscription Status</h2>
                            <template x-if="authenticatedUser && authenticatedUser.profile">
                                <div class="text-gray-300 text-sm space-y-1">
                                    <p><strong>Current Plan:</strong> <span x-text="authenticatedUser.profile.subscription_plan ? authenticatedUser.profile.subscription_plan.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'"></span></p>
                                    <p x-show="authenticatedUser.profile.subscription_expiry_date"><strong>Expires on:</strong> <span x-text="formatSimpleDate(authenticatedUser.profile.subscription_expiry_date)"></span></p>
                                    <a x-show="!authenticatedUser.profile.subscription_plan || authenticatedUser.profile.subscription_plan === 'free_trial' || authenticatedUser.profile.subscription_plan === 'cancelled'" 
                                       href="url 'payments:list_plans'" class="mt-3 inline-block bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md text-sm">
                                        Upgrade to Pro
                                    </a>
                                     <a x-show="authenticatedUser.profile.subscription_plan && authenticatedUser.profile.subscription_plan !== 'free_trial' && authenticatedUser.profile.subscription_plan !== 'cancelled'" 
                                       href="url 'payments:list_plans'" class="mt-3 inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md text-sm">
                                        Manage Subscription
                                    </a>
                                </div>
                            </template>
                             <p x-show="authenticatedUser && !authenticatedUser.profile" class="text-gray-400 text-sm">Loading subscription details...</p>
                             <p x-show="!authenticatedUser" class="text-gray-400 text-sm">Login to view subscription details.</p>
                        </section>
                    </div>
                </div>
            </div> </main>
    </div> <div x-show="showVideoModal" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         role="dialog" aria-modal="true" :aria-labelledby="videoToPlay ? `modal-video-title-${videoToPlay.id}` : 'video-player-modal-title'">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden" @click.away="closeVideoModal()">
            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white truncate" x-text="videoToPlay?.title || 'Video Player'" :id="videoToPlay ? `modal-video-title-${videoToPlay.id}` : 'video-player-modal-title'"></h3>
                <button @click="closeVideoModal()" class="text-gray-400 hover:text-white focus:outline-none focus-visible:ring-1 focus-visible:ring-indigo-400" aria-label="Close video player modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-1 sm:p-2 aspect-video bg-black flex-grow">
                 <video id="modal-video-player" playsinline controls data-plyr-config='{ "ratio": "16:9" }' aria-label="Video content"></video>
            </div>
            <div class="p-3 text-xs text-gray-400 border-t border-gray-700">
                <p>Source: <a :href="videoToPlay?.primary_source_display?.original_url || videoToPlay?.sources?.[0]?.original_url" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:underline" x-text="videoToPlay?.primary_source_display?.original_url || videoToPlay?.sources?.[0]?.original_url || 'N/A'"></a></p>
                <p x-show="videoToPlay?.primary_source_display?.best_match_timestamp_ms">
                    Jump to relevant segment: 
                    <button type="button" @click="seekPlayerTo(videoToPlay.primary_source_display.best_match_timestamp_ms / 1000)"
                            class="text-indigo-300 hover:underline" 
                            x-text="formatTimestamp(videoToPlay.primary_source_display.best_match_timestamp_ms)"></button>
                </p>
            </div>
        </div>
    </div>
    
    <div x-show="globalNotification.visible" x-cloak
         class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white text-sm z-[100] max-w-sm"
         :class="{ 
             'bg-green-600': globalNotification.type === 'success', 
             'bg-red-600': globalNotification.type === 'error',
             'bg-blue-600': globalNotification.type === 'info',
             'bg-yellow-600': globalNotification.type === 'warning'
         }"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform translate-y-2"
         role="alert" aria-live="assertive">
        <p x-text="globalNotification.message"></p>
        <button @click="globalNotification.visible = false" class="absolute top-1 right-2 text-xl font-bold hover:text-white/70" aria-label="Dismiss notification">&times;</button>
    </div>

    <script id="django-context" type="application/json">
        {{ django_context_json|safe if django_context_json else '{}' }}
    </script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="static 'js/papriapp.js'"></script>
</body>
</html>
